# CCGate

Claude code API çš„äºŒæ¬¡åˆ†å‘åå‘ä»£ç†æœåŠ¡å™¨ï¼Œæ”¯æŒé…ç½®å¤šä¸ªä¸Šæ¸¸ï¼ˆAnthropicå®˜æ–¹ï¼Œå„å®¶Claude codeé•œåƒç«™ï¼‰ï¼Œå¤šç§è´Ÿè½½å‡è¡¡ç®—æ³•ï¼Œæ”¯æŒé…ç½®å¤šä¸ªç§Ÿæˆ·ã€ä»¥åŠå„ä¸ªç§Ÿæˆ·çš„æƒé™ï¼Œå„ä¸ªç§Ÿæˆ·å¯ä»¥æŸ¥çœ‹è‡ªå·±ç”¨é‡

ä¸€ä¸ªç–‘é—®è§£ç­”ï¼šå·²ç»æœ‰äº†å¼ºå¤§çš„ [Wei-Shaw/claude-relay-service](https://github.com/Wei-Shaw/claude-relay-service) æ­å»ºClaude code é•œåƒç«™ï¼Œä¸ºä»€ä¹ˆè¿˜éœ€è¦æœ¬é¡¹ç›®ï¼Ÿ

å› ä¸º CRS çš„ä¸Šæ¸¸ä»…æ”¯æŒé…ç½® Claude è´¦å·ç™»å½•ï¼Œæ‰€ä»¥å¿…é¡»ä¹°å®˜æ–¹å¥—é¤ï¼Œä¸æ”¯æŒé…ç½®é•œåƒç«™çš„APIã€‚åœ¨ä¸€ä¸ªåœºæ™¯ä¸‹ï¼Œ**å³å‡ ä¸ªæœ‹å‹æˆ–å®¶äººç”¨é‡ä¸å¤§ï¼Œåˆä¸æƒ³ç»å¸¸ç›´é¢Claudeå°å·ä¸ç¨³å®šé—®é¢˜** (éœ€è¦ç»å¸¸æ‰¾å¯ç”¨åŒºåŸŸçš„ä¿¡ç”¨å¡å’ŒIP)ï¼Œæƒ³æŠŠè¿™ä¸ªé—®é¢˜äº¤ç»™é•œåƒç«™ï¼Œå°±å¯ä»¥ä¹°å„å®¶ Claude code é•œåƒç«™çš„APIï¼Œç„¶åä½¿ç”¨æœ¬é¡¹ç›®è¿›è¡ŒäºŒæ¬¡é•œåƒ

## âœ¨ ç‰¹æ€§

- ğŸš€ **é«˜æ€§èƒ½ä»£ç†** - åŸºäº Node.js åŸç”Ÿ HTTP æ¨¡å—ï¼Œæ”¯æŒæµå¼å“åº”
- ğŸ¢ **å¤šç§Ÿæˆ·ç®¡ç†** - æ”¯æŒå¤šä¸ªç§Ÿæˆ·ç‹¬ç«‹ä½¿ç”¨ï¼Œæƒé™éš”ç¦»
- âš–ï¸ **è´Ÿè½½å‡è¡¡** - æ”¯æŒå¤šç§è´Ÿè½½å‡è¡¡ç­–ç•¥å’Œè‡ªåŠ¨æ•…éšœè½¬ç§»
- ğŸ“Š **ç”¨é‡ç»Ÿè®¡** - ç²¾ç¡®çš„ Token çº§åˆ«è®¡é‡å’Œæˆæœ¬è·Ÿè¸ª
- ğŸ” **æƒé™æ§åˆ¶** - åŸºäº API Key çš„è®¤è¯å’Œæ¨¡å‹è®¿é—®æ§åˆ¶
- ğŸ’° **æˆæœ¬ç®¡ç†** - æ”¯æŒæ¯æ—¥ç”¨é‡é™é¢å’Œå®æ—¶æˆæœ¬ç›‘æ§
- ğŸ” **å¥åº·æ£€æŸ¥** - ä¸Šæ¸¸æœåŠ¡å™¨å¥åº·ç›‘æ§å’Œè‡ªåŠ¨åˆ‡æ¢

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒè¦æ±‚

- Node.js >= 14.0.0
- npm æˆ– pnpm

### å®‰è£…

```bash
# å…‹éš†é¡¹ç›®
git clone https://github.com/fengerwoo/CCGate.git
cd CCGate

# å®‰è£…ä¾èµ–ï¼ˆæ¨èä½¿ç”¨ pnpmï¼‰
pnpm install
# æˆ–ä½¿ç”¨ npm
npm install
```

### é…ç½®

å¤åˆ¶é…ç½®ç¤ºä¾‹æ–‡ä»¶å¹¶ä¿®æ”¹ï¼š

```bash
# å¤åˆ¶ä¸Šæ¸¸æœåŠ¡å™¨é…ç½®
cp config/upstreams.json.example config/upstreams.json

# å¤åˆ¶ç§Ÿæˆ·é…ç½®
cp config/tenants.json.example config/tenants.json
```

#### 1. é…ç½®ä¸Šæ¸¸æœåŠ¡å™¨ (`config/upstreams.json`)

```json
{
  "upstreams": [                        //å¯ä»¥é…ç½®å¤šä¸ªä¸Šæ¸¸
    {
      "id": "upstream-1",                        // ä¸Šæ¸¸æœåŠ¡å™¨å”¯ä¸€æ ‡è¯†
      "name": "Claude API æœåŠ¡å™¨",              // æœåŠ¡å™¨æ˜¾ç¤ºåç§°
      "url": "https://api.anthropic.com",       // API æœåŠ¡å™¨åœ°å€
      "key": "sk-your-api-key",                // API å¯†é’¥
      "description": "å®˜æ–¹ Claude API",         // æœåŠ¡å™¨æè¿°
      "weight": 100,                           // è´Ÿè½½å‡è¡¡æƒé‡ï¼ˆæ•°å€¼è¶Šå¤§ï¼Œæµé‡åˆ†é…è¶Šå¤šï¼‰
      "enabled": true                          // æ˜¯å¦å¯ç”¨æ­¤ä¸Šæ¸¸æœåŠ¡å™¨
    }
  ],
  "loadBalancer": {
    "strategy": "weighted_round_robin",        // è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼Œä¸€èˆ¬ weighted_round_robin å³å¯ï¼Œè¯¦è§æ–‡æ¡£åº•éƒ¨"è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼Œå¯é€‰ç­–ç•¥"ï¼šweighted_round_robin/round_robin/random/least_connections
    "healthCheckEnabled": true,               // æ˜¯å¦å¯ç”¨å¥åº·æ£€æŸ¥
    "failoverEnabled": true                   // æ˜¯å¦å¯ç”¨æ•…éšœè½¬ç§»
  }
}
```

#### 2. é…ç½®ç§Ÿæˆ· (`config/tenants.json`)

```json
{
  "tenants": [                         // å¯ä»¥é…ç½®å¤šä¸ªç§Ÿæˆ·
    {
      "id": "tenant-1",                         // ç§Ÿæˆ·å”¯ä¸€æ ‡è¯†
      "name": "fenger",                        // ç§Ÿæˆ·æ˜¾ç¤ºåç§°
      "key": "your-unique-api-key",           // ç§Ÿæˆ·ä¸“ç”¨APIå¯†é’¥ï¼ˆå®¢æˆ·ç«¯ä½¿ç”¨æ­¤å¯†é’¥è®¿é—®ï¼‰
      "enabled": true,                        // æ˜¯å¦å¯ç”¨æ­¤ç§Ÿæˆ·
      "allowedModels": ["*sonnet*", "*haiku*"], // å…è®¸ä½¿ç”¨çš„æ¨¡å‹ï¼ˆæ”¯æŒ*ä½œä¸ºé€šé…ç¬¦ï¼‰
      "limits": {
        "daily": {
          "maxUSD": 100.0                     // æ¯æ—¥æœ€å¤§æ¶ˆè´¹é™é¢ï¼ˆç¾å…ƒï¼‰
        }
      }
    }
  ]
}
```

#### 3. ä¿®æ”¹ç®¡ç†å‘˜å¯†ç  (`config/server.json`)

âš ï¸ **é‡è¦ï¼šä¿®æ”¹é»˜è®¤ç®¡ç†å‘˜å¯†ç **

```json
{
  "admin": {
    "enabled": true,                          // æ˜¯å¦å¯ç”¨ç®¡ç†åå°
    "path": "/admin",                        // ç®¡ç†åå°è®¿é—®è·¯å¾„
    "username": "admin",                     // ç®¡ç†å‘˜ç”¨æˆ·å
    "password": "your-secure-password"       // ç®¡ç†å‘˜å¯†ç ï¼ˆè¯·åŠ¡å¿…ä¿®æ”¹ï¼‰
  }
}
```

### å¯åŠ¨æœåŠ¡

```bash
# å¼€å‘æ¨¡å¼ï¼ˆè‡ªåŠ¨é‡å¯ï¼‰
pnpm run dev
# æˆ– npm run dev

# ç”Ÿäº§ç¯å¢ƒ
pnpm start
# æˆ– npm start

# ç›´æ¥å¯åŠ¨
node server.js
```

### Claude code å®¢æˆ·ç«¯ä½¿ç”¨

ğŸ”¥ Claude code ä»£ç†URL: `http://localhost:3000/anthropic`

```bash
export ANTHROPIC_BASE_URL=http://localhost:3000/anthropic
# æ­¤æ¬¡ä½¿ç”¨é…ç½®çš„å¯¹åº”ç§Ÿæˆ·çš„key
export ANTHROPIC_AUTH_TOKEN=sk-...

```

## ğŸ“Š ç”¨é‡æŸ¥è¯¢

ç”¨é‡æŸ¥çœ‹é¢æ¿ï¼š`http://localhost:3000/dashboard`

### ç®¡ç†å‘˜æŸ¥çœ‹


- ç”¨æˆ·åï¼š`admin`ï¼ˆåœ¨ `config/server.json` ä¸­é…ç½®ï¼‰
- å¯†ç ï¼š**è¯·åŠ¡å¿…ä¿®æ”¹é»˜è®¤å¯†ç **
- ç®¡ç†å‘˜å¯ä»¥æŸ¥çœ‹æ€»ä½“ä¿¡æ¯å’Œå„ç§Ÿæˆ·å®æ—¶ç”¨é‡

![ç®¡ç†å‘˜ç”¨é‡æŸ¥è¯¢](docs/images/usage-query-admin.jpg)

### ç§Ÿæˆ·æŸ¥çœ‹

ä½¿ç”¨ç§Ÿæˆ·çš„ API Key æŸ¥è¯¢è‡ªå·±çš„ç”¨é‡ç»Ÿè®¡ã€‚

![ç§Ÿæˆ·ç”¨é‡æŸ¥è¯¢](docs/images/usage-query-user.jpg)

## ğŸ”§ æ›´å¤šè®¾ç½®


### API ç«¯ç‚¹

- `POST /anthropic` - Claude code ä»£ç†çš„ url
- `GET /health` - å¥åº·æ£€æŸ¥
- `POST /usage` - ç”¨é‡æŸ¥è¯¢ API


## ğŸ“‹ å¯ç”¨å‘½ä»¤

```bash
# å¼€å‘ç›¸å…³
pnpm run dev              # å¼€å‘æ¨¡å¼å¯åŠ¨ï¼ˆè‡ªåŠ¨é‡å¯ï¼‰
pnpm start               # ç”Ÿäº§ç¯å¢ƒå¯åŠ¨

# å·¥å…·å‘½ä»¤
pnpm run config:validate # éªŒè¯é…ç½®æ–‡ä»¶
pnpm run health          # æ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€
pnpm run clean           # æ¸…ç†æ—¥å¿—å’Œç”¨é‡æ•°æ®
```

### ç”¨é‡æ•°æ®

ç”¨é‡æ•°æ®è‡ªåŠ¨æŒ‰ä»¥ä¸‹ç»“æ„å­˜å‚¨ï¼š

```
data/usage/
â””â”€â”€ {tenant-id}/
    â””â”€â”€ {YYYY-MM}/
        â””â”€â”€ {YYYY-MM-DD}.json
```

æ¯ä¸ªæ–‡ä»¶åŒ…å«è¯¥ç§Ÿæˆ·å½“æ—¥çš„è¯¦ç»†ç”¨é‡ç»Ÿè®¡ã€‚

## âš™ï¸ é…ç½®è¯´æ˜

### è´Ÿè½½å‡è¡¡ç­–ç•¥

- `round_robin` - è½®è¯¢
- `weighted_round_robin` - åŠ æƒè½®è¯¢ï¼ˆæ¨èï¼‰
- `random` - éšæœºé€‰æ‹©
- `least_connections` - æœ€å°‘è¿æ¥

### æ¨¡å‹æƒé™æ§åˆ¶

åœ¨ç§Ÿæˆ·é…ç½®ä¸­ä½¿ç”¨é€šé…ç¬¦æ§åˆ¶æ¨¡å‹è®¿é—®ï¼š

```json
{
  "allowedModels": [
    "*sonnet*",    # å…è®¸æ‰€æœ‰ Sonnet æ¨¡å‹
    "*haiku*",     # å…è®¸æ‰€æœ‰ Haiku æ¨¡å‹
    "*"            # å…è®¸æ‰€æœ‰æ¨¡å‹
  ]
}
```

### ç”¨é‡é™åˆ¶

æ”¯æŒå¤šçº§ç”¨é‡é™åˆ¶ï¼š

```json
{
  "limits": {
    "daily": {
      "maxUSD": 100.0,      # æ¯æ—¥æœ€å¤§æˆæœ¬ï¼ˆç¾å…ƒï¼‰
      "maxRequests": 1000   # æ¯æ—¥æœ€å¤§è¯·æ±‚æ•°
    }
  }
}
```

## ğŸ” æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **æœåŠ¡æ— æ³•å¯åŠ¨**
   - æ£€æŸ¥ç«¯å£ 3000 æ˜¯å¦è¢«å ç”¨
   - éªŒè¯é…ç½®æ–‡ä»¶æ ¼å¼ï¼š`pnpm run config:validate`

2. **è®¤è¯å¤±è´¥**
   - ç¡®è®¤ç§Ÿæˆ·çš„ API Key æ­£ç¡®é…ç½®
   - æ£€æŸ¥ç§Ÿæˆ·æ˜¯å¦å¯ç”¨ï¼š`"enabled": true`

3. **ä¸Šæ¸¸è¿æ¥å¤±è´¥**
   - æ£€æŸ¥ä¸Šæ¸¸æœåŠ¡å™¨ URL å’Œ API Key
   - æŸ¥çœ‹å¥åº·æ£€æŸ¥çŠ¶æ€ï¼š`pnpm run health`

4. **ç”¨é‡ç»Ÿè®¡å¼‚å¸¸**
   - æ£€æŸ¥ `data/usage/` ç›®å½•æƒé™
   - æŸ¥çœ‹æœåŠ¡æ—¥å¿—ï¼š`tail -f data/logs/combined.log`

### æ—¥å¿—ä½ç½®

- ç»¼åˆæ—¥å¿—ï¼š`data/logs/combined.log`
- é”™è¯¯æ—¥å¿—ï¼š`data/logs/error.log`
- è®¿é—®æ—¥å¿—ï¼š`data/logs/access.log`

## ğŸ“„ è®¸å¯è¯

ISC

## ğŸ¤ è´¡çŒ®

æ¬¢è¿æäº¤ Issue å’Œ Pull Requestï¼

---

â­ å¦‚æœè¿™ä¸ªé¡¹ç›®å¯¹ä½ æœ‰å¸®åŠ©ï¼Œè¯·ç»™ä¸ªæ˜Ÿæ ‡æ”¯æŒä¸€ä¸‹ï¼